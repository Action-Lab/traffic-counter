<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Traffic Counter</title>

    <style>
    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial;
    }

    h1, h2 {
      text-align: center;
    }

    .count-button {
      min-height: 15vh;
      width: calc(50% - 23px);
      margin: 0 3px 3px 0;
      padding: 10px;
      background-color: #eee;
      float: left;
      cursor: pointer;
      color: #000;
      font-size: 1.2em;
    }

    .count-button:hover {
      background-color: #ccc;
    }

    input[type="button"] {
      font-size: 2em;
    }

    #page1 {
      height: calc(100vh - 50px);
      display: none;
      margin: 0;
    }

    #page1 {
      text-align: center;
      font-size: 1.5em;
    }

    #page1 input[type="text"] {
      text-align: center;
      font-size: 1.2em;
      max-width: 80%;
    }

    .count-button-container {
      display: none;
    }

    </style>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>

    <script src="https://www.gstatic.com/firebasejs/5.0.4/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyCIyVEMVuvYo_TJB7EX1di0tt7RD6eCcYA",
        authDomain: "traffic-counter-1528267293109.firebaseapp.com",
        databaseURL: "https://traffic-counter-1528267293109.firebaseio.com",
        projectId: "traffic-counter--1528267293109",
        storageBucket: "",
        messagingSenderId: "852588564259"
      };
      firebase.initializeApp(config);

      var database = firebase.database();
    </script>

    <script src="https://cdn.firebase.com/libs/firebaseui/3.0.0/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.0.0/firebaseui.css" />

    <script type="text/javascript">
      // FirebaseUI config
      var uiConfig = {
        signInSuccessUrl: 'https://ilyankou.github.io/traffic-counter/index.html',
        //signInSuccessUrl: 'http://localhost:8080',
        signInOptions: [
          firebase.auth.GoogleAuthProvider.PROVIDER_ID,
          //firebase.auth.EmailAuthProvider.PROVIDER_ID,
        ]
      };

      // Initialize the FirebaseUI Widget using Firebase.
      var ui = new firebaseui.auth.AuthUI(firebase.auth());
      // The start method will wait until the DOM is loaded.
      ui.start('#firebaseui-auth-container', uiConfig);

      var lat = 0;
      var lon = 0;

      function getLocation() {
        return lat.toFixed(2) + ',' + lon.toFixed(2);
      }

      function updateLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            lat = position.coords.latitude;
            lon = position.coords.longitude;
          }, function(error) {
            console.log(error);
          });
        }

        setTimeout(updateLocation, 10000);
      }

      updateLocation();

      $(document).ready(function() {
        // Add event listener that would show/hide app on authentication
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            loadApp(user);
          }
        }, function(error) {
          console.log(error);
        });
      });



      function loadApp(user) {
        $('#firebaseui-auth-container').css('display', 'none');

        $('h2').html(user.displayName + ' (<i><a href="#" class="logout">Log Out</a></i>)');

        $('.logout').click(function() {
          firebase.auth().signOut().then(function() {
            location.reload();
          }, function(error) {
            console.log(error);
          });
        })

        $('#page1').css('display', 'block');

        $('#nextButton').click(function() {
          $('#page1').css('display', 'none');
          $('h2').css('display', 'none');
          var counter = $('input[name="counter"]').val();
          $('#' + counter).css('display', 'block');
        });

        // On Button click, retrieve all data from the forms and send it to the Firebase
        $('.count-button').click(function() {

          var code = parseInt($(this).attr('code'));
          var count = parseInt($(this).attr('count'));
          var temp = parseInt($('#temp').val());
          var weather = $('#weather').val();

          pushEntry({
            name: user.displayName,
            email: user.email,
            time: new Date().toString(),
            intersection: '',
            code: code,
            count: count,
            weather: weather,
            temp: temp,
            location: getLocation(),
          });

        });
      }

      function pushEntry(params) {
        database.ref('/').push(params, function(error) {
          if (error) {
            toast(1);
            console.log(error);
          } else {
            toast(0);
          }
        });
      }


      function toast(code) {
        if (code == 0) {
          console.log('ok')
          $('body').append('<span style="color:green">added</span><br>');
        } else {
          console.log('shit')
          $('body').append('<span style="color:red">error</span><br>');
        }
      }

    </script>
  </head>


  <body>

    <h1>Traffic Counter</h1>
    <h2></h2>

    <div id="firebaseui-auth-container"></div>

    <div id="page1">
      Intersection<br>
      <input type="text" id="temp" value="72"><br><br>

      Weather<br>
      <input type="text" id="weather" value="cloudy"><br><br>

      Temperature<br>
      <input type="text" id="temp" value="72"><br><br>

      <label>
        <input type="radio" name="counter" value="cars" checked> Cars
      </label>

      <label>
        <input type="radio" name="counter" value="behaviors"> Driver Behaviors
      </label>

      <label>
        <input type="radio" name="counter" value="bikers"> Bikers + Walkers
      </label>

      <br><br>

      <input type="button" value="Next" id="nextButton">
    </div>


    <div id="cars" class="count-button-container">
      <div class="count-button" code=10 count=1>
        Total cars
        <br>

        <i class="fas fa-car"></i>
      </div>

      <div class="count-button" code=10 count=5>
        Total cars
        <br>

        <i class="fas fa-car"></i>
        <i class="fas fa-car"></i>
        <i class="fas fa-car"></i>
        <i class="fas fa-car"></i>
        <i class="fas fa-car"></i>
      </div>

      <div class="count-button" code=11 count=1>
        Running red light
        <br>

        <i class="fas fa-circle" style="color: red;"></i>
      </div>

      <div class="count-button" code=11 count=5>
        Running red light
        <br>

        <i class="fas fa-circle" style="color: red;"></i>
        <i class="fas fa-circle" style="color: red;"></i>
        <i class="fas fa-circle" style="color: red;"></i>
        <i class="fas fa-circle" style="color: red;"></i>
        <i class="fas fa-circle" style="color: red;"></i>
      </div>

      <div class="count-button" code=12 count=1>
        Rolling right on red
        <br>

        <i class="fas fa-arrow-right" style="color: red;"></i>
      </div>

      <div class="count-button" code=12 count=5>
        Rolling right on red
        <br>

        <i class="fas fa-arrow-right" style="color: red;"></i>
        <i class="fas fa-arrow-right" style="color: red;"></i>
        <i class="fas fa-arrow-right" style="color: red;"></i>
        <i class="fas fa-arrow-right" style="color: red;"></i>
        <i class="fas fa-arrow-right" style="color: red;"></i>
      </div>

      <div class="count-button" code=13 count=1>
        Left turn w/o yielding
        <br>
        <i class="far fa-arrow-alt-circle-left"></i>

      </div>

      <div class="count-button" code=13 count=5>
        Left turn w/o yielding
        <br>

        <i class="far fa-arrow-alt-circle-left"></i>
        <i class="far fa-arrow-alt-circle-left"></i>
        <i class="far fa-arrow-alt-circle-left"></i>
        <i class="far fa-arrow-alt-circle-left"></i>
        <i class="far fa-arrow-alt-circle-left"></i>
      </div>
    </div>

    <div id="behaviors" class="count-button-container"></div>

    <div id="bikers" class="count-button-container"></div>


  </body>

</html>
